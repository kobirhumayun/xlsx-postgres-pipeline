generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Dataset {
  id               Int        @id @default(autoincrement())
  slug             String     @unique
  name             String
  defaultSheetName String?
  pkFields         Json
  mapping          Json
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  importRuns       ImportRun[]
  rawRows          RawRow[]
  curatedRows      CuratedRow[]
  relationshipsLeft  Relationship[] @relation("LeftDataset")
  relationshipsRight Relationship[] @relation("RightDataset")

  @@map("datasets")
}

model ImportRun {
  id         Int      @id @default(autoincrement())
  datasetId  Int
  fileName   String
  fileHash   String
  importedAt DateTime @default(now())
  totalRows  Int
  okRows     Int
  errorRows  Int
  notes      String?
  dataset    Dataset  @relation(fields: [datasetId], references: [id])
  rawRows    RawRow[]
  curatedRows CuratedRow[]

  @@map("import_runs")
}

model RawRow {
  id             Int      @id @default(autoincrement())
  datasetId      Int
  importRunId    Int
  rowNumber      Int
  businessKey    String
  rowJson        Json
  rowHash        String
  parsedOk       Boolean
  parseErrors    Json
  createdAt      DateTime @default(now())
  dataset        Dataset  @relation(fields: [datasetId], references: [id])
  importRun      ImportRun @relation(fields: [importRunId], references: [id])

  @@index([datasetId, businessKey])
  @@map("raw_rows")
}

model Relationship {
  id             Int      @id @default(autoincrement())
  name           String
  leftDatasetId  Int
  rightDatasetId Int
  joinMapping    Json
  createdAt      DateTime @default(now())
  leftDataset    Dataset  @relation("LeftDataset", fields: [leftDatasetId], references: [id])
  rightDataset   Dataset  @relation("RightDataset", fields: [rightDatasetId], references: [id])

  @@map("relationships")
}

model CuratedRow {
  id              Int      @id @default(autoincrement())
  datasetId       Int
  businessKey     String
  normalized      Json
  typedColumns    Json?
  lastImportRunId Int?
  updatedAt       DateTime @updatedAt
  dataset         Dataset  @relation(fields: [datasetId], references: [id])
  importRun       ImportRun? @relation(fields: [lastImportRunId], references: [id])

  @@index([datasetId, businessKey])
  @@unique([datasetId, businessKey])
  @@map("curated_rows")
}
